#!/usr/bin/env bash
set -euo pipefail

# --- envtest binaries (for controller integration tests)
echo "--- :golang: Installing setup-envtest"
go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest

echo "--- :golang: Setting up envtest binaries"
export KUBEBUILDER_ASSETS="$(setup-envtest use --bin-dir /tmp/envtest -p path)"
echo "KUBEBUILDER_ASSETS=${KUBEBUILDER_ASSETS}"

# --- frp binaries (for frp integration tests)
FRP_VERSION="0.61.1"
FRP_OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
case "$(uname -m)" in
  x86_64)  FRP_ARCH="amd64" ;;
  aarch64|arm64) FRP_ARCH="arm64" ;;
  *)       echo "Unsupported architecture: $(uname -m)" >&2; exit 1 ;;
esac
FRP_DIR="/tmp/frp_${FRP_VERSION}_${FRP_OS}_${FRP_ARCH}"

echo "--- :package: Downloading frp ${FRP_VERSION} (${FRP_OS}/${FRP_ARCH})"
if [[ ! -x "${FRP_DIR}/frps" ]]; then
  curl -fsSL "https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_${FRP_OS}_${FRP_ARCH}.tar.gz" \
    | tar -xz -C /tmp
fi

echo "frps: $(${FRP_DIR}/frps --version)"
echo "frpc: $(${FRP_DIR}/frpc --version)"

export FRP_BIN_DIR="${FRP_DIR}"

# --- run all tests (unit + envtest + frp integration)
echo "+++ :golang: Running tests"
go test -tags integration ./... -v -count=1
